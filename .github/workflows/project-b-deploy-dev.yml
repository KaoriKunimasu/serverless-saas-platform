name: Project B - deploy dev (api)

on:
  push:
    branches: ["main", "project-b/*"]
    paths:
      - "apps/b-api/**"
      - "infra/b-ecs/envs/dev/**"
      - ".github/workflows/project-b-deploy-dev.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-southeast-2
  ECR_REPO: project-b-dev-api
  ECS_CLUSTER: project-b-dev-cluster
  ECS_SERVICE: project-b-dev-api
  CONTAINER_NAME: api

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::515241425905:role/github-actions-project-b-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image (immutable tag)
        id: build
        run: |
          IMAGE_TAG="${GITHUB_SHA::7}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          ECR_URI=$(aws ecr describe-repositories --repository-names "${ECR_REPO}" --query 'repositories[0].repositoryUri' --output text)

          docker build -t "${ECR_URI}:${IMAGE_TAG}" ./apps/b-api
          docker push "${ECR_URI}:${IMAGE_TAG}"

          echo "ecr_uri=${ECR_URI}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Download current task definition (from service)
        run: |
          TD_ARN=$(aws ecs describe-services \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}" \
            --query "services[0].taskDefinition" \
            --output text)

          aws ecs describe-task-definition \
            --task-definition "$TD_ARN" \
            --query taskDefinition > task-definition.json

      - name: Render task definition with new image
        id: render
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition.json
          container-name: ${{ env.CONTAINER_NAME }}
          image: "${{ steps.build.outputs.ecr_uri }}:${{ steps.build.outputs.image_tag }}"

      - name: Deploy task definition to Amazon ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: "${{ steps.render.outputs.task-definition }}"
          service: "${{ env.ECS_SERVICE }}"
          cluster: "${{ env.ECS_CLUSTER }}"
          wait-for-service-stability: true

      - name: Brief wait before smoke test
        run: sleep 10

      - name: Smoke test (retry + tolerate 504)
        shell: bash
        run: |
          set -euo pipefail

          # If ALB doesn't exist (cost-saving mode), skip smoke test gracefully.
          ALB_DNS="$(aws elbv2 describe-load-balancers \
            --names "project-b-dev-alb" \
            --query "LoadBalancers[0].DNSName" \
            --output text 2>/dev/null || true)"

          if [ -z "${ALB_DNS}" ] || [ "${ALB_DNS}" = "None" ] || [ "${ALB_DNS}" = "null" ]; then
            echo "ALB not found (likely enable_alb=false). Skipping smoke test."
            exit 0
          fi

          echo "ALB_DNS=$ALB_DNS"

          # wait until /health is stable (tolerate transient 5xx like 504 during deployments)
          ok=0
          for i in $(seq 1 30); do
            code=$(curl -s -o /tmp/health.json -w "%{http_code}" "http://${ALB_DNS}/health" || true)
            echo "try $i: /health http=$code body=$(cat /tmp/health.json 2>/dev/null || true)"
            if [ "$code" = "200" ]; then ok=1; break; fi
            sleep 10
          done

          if [ "$ok" != "1" ]; then
            echo "health never became 200"
            exit 1
          fi

          # optional checks (do not fail the workflow)
          curl -fsS "http://${ALB_DNS}/burn?ms=50" || echo "/burn not ready yet"
          curl -fsS "http://${ALB_DNS}/db-check" || echo "/db-check failed (DB may be starting)"

