name: Project B - deploy dev (api)

on:
  push:
    branches: ["main"]
    paths:
      - "apps/b-api/**"
      - "infra/b-ecs/envs/dev/**"
      - ".github/workflows/project-b-deploy-dev.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-southeast-2
  ECR_REPO: project-b-dev-api
  ECS_CLUSTER: project-b-dev-cluster
  ECS_SERVICE: project-b-dev-api
  CONTAINER_NAME: api

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::515241425905:role/github-actions-project-b-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image (immutable tag)
        id: build
        run: |
          IMAGE_TAG="${GITHUB_SHA::7}-${GITHUB_RUN_ID}"
          ECR_URI=$(aws ecr describe-repositories --repository-names "${ECR_REPO}" --query 'repositories[0].repositoryUri' --output text)

          docker build -t "${ECR_URI}:${IMAGE_TAG}" ./apps/b-api
          docker push "${ECR_URI}:${IMAGE_TAG}"

          echo "ecr_uri=${ECR_URI}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Download current task definition (from service)
        run: |
          TD_ARN=$(aws ecs describe-services \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}" \
            --query "services[0].taskDefinition" \
            --output text)

          aws ecs describe-task-definition \
            --task-definition "$TD_ARN" \
            --query taskDefinition > task-definition.json

      - name: Render task definition with new image
        id: render
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition.json
          container-name: ${{ env.CONTAINER_NAME }}
          image: "${{ steps.build.outputs.ecr_uri }}:${{ steps.build.outputs.image_tag }}"

      - name: Deploy task definition to Amazon ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: "${{ steps.render.outputs.task-definition }}"
          service: "${{ env.ECS_SERVICE }}"
          cluster: "${{ env.ECS_CLUSTER }}"
          wait-for-service-stability: true

      - name: Brief wait before smoke test
        run: sleep 10

      - name: Smoke test (discover ALB DNS)
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          ALB_NAME: project-b-dev-alb
        run: |
          set -euo pipefail

          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --region "$AWS_REGION" \
            --names "$ALB_NAME" \
            --query "LoadBalancers[0].DNSName" \
            --output text)

          echo "ALB DNS: $ALB_DNS"

          for i in {1..12}; do
            echo "Smoke attempt $i/12"
            if curl -fsS "http://$ALB_DNS/health" && curl -fsS "http://$ALB_DNS/db-check"; then
              echo "Smoke test OK"
              exit 0
            fi
            sleep 10
          done

          echo "Smoke test failed after retries"
          exit 1
